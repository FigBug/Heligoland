name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-macos:
    runs-on: macos-latest
    name: Build macOS
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Keychain
        env:
          APPLICATION: ${{ secrets.APPLICATION }}
          INSTALLER: ${{ secrets.INSTALLER }}
          CERT_PASS: ${{ secrets.CERT_PASS }}
          KEYCHAIN_PASS: ${{ secrets.KEYCHAIN_PASS }}
        run: |
          security create-keychain -p "$KEYCHAIN_PASS" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASS" build.keychain
          security set-keychain-settings -l -u -t 13600 build.keychain

          echo "$APPLICATION" | base64 -D -o /tmp/Application.p12
          security import /tmp/Application.p12 -t agg -k build.keychain -P "$CERT_PASS" -A -T /usr/bin/codesign

          echo "$INSTALLER" | base64 -D -o /tmp/Installer.p12
          security import /tmp/Installer.p12 -t agg -k build.keychain -P "$CERT_PASS" -A -T /usr/bin/productbuild -T /usr/bin/productsign

          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASS" build.keychain

      - name: Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release

      - name: Sign Application
        run: |
          codesign --deep --force --verify --verbose --timestamp \
            --options runtime \
            --sign "$DEV_ID" \
            build/Heligoland.app
        env:
          DEV_ID: ${{ secrets.DEV_ID }}

      - name: Create Installer
        run: cd build && cpack -G productbuild

      - name: Sign Installer
        run: |
          cd build
          PKG_FILE=$(ls Heligoland-*.pkg)
          productsign --sign "$INSTALLER_ID" "$PKG_FILE" "signed-$PKG_FILE"
          mv "signed-$PKG_FILE" "$PKG_FILE"
        env:
          INSTALLER_ID: ${{ secrets.INSTALLER_ID }}

      - name: Notarize Installer
        run: |
          cd build
          PKG_FILE=$(ls Heligoland-*.pkg)

          xcrun notarytool submit \
            --apple-id "$APPLE_USER" \
            --password "$APPLE_PASS" \
            --team-id "$TEAM_ID" \
            --wait --timeout 30m \
            "$PKG_FILE"

          xcrun stapler staple "$PKG_FILE"
        env:
          APPLE_USER: ${{ secrets.APPLE_USER }}
          APPLE_PASS: ${{ secrets.APPLE_PASS }}
          TEAM_ID: ${{ secrets.TEAM_ID }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macOS
          path: build/Heligoland-*.pkg

  build-windows:
    runs-on: windows-latest
    name: Build Windows
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install NSIS
        run: choco install nsis -y

      - name: Build and Package
        shell: bash
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64
          cmake --build build --config Release
          cd build && cpack -G NSIS -C Release

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows
          path: build/Heligoland-*.exe

  build-linux:
    runs-on: ubuntu-latest
    name: Build Linux
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libx11-dev libxext-dev libxrandr-dev libxcursor-dev libxi-dev libxinerama-dev libasound2-dev

      - name: Build and Package
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build
          cd build && cpack -G DEB

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Linux
          path: build/heligoland_*.deb

  release:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Extract release notes
        id: release_notes
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          # Extract notes for current version (from version line to next version or EOF)
          NOTES=$(awk "/^$VERSION\$/{found=1; next} /^[0-9]+\.[0-9]+\.[0-9]+\$/{if(found) exit} found{print}" Changelist.txt)
          # Use delimiter for multiline output
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/macOS/*
            artifacts/Windows/*
            artifacts/Linux/*
          body: ${{ steps.release_notes.outputs.notes }}
